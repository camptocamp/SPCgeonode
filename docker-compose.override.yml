version: '3.4'

services:
  postgres:
    ports:
      - "5432:5432"
    # volumes:
      # - ./_volume_database:/var/lib/postgresql/data/ # doesn't work because of ownership
  nginx:
    image: olivierdalang/spcgeonode:nginx-dev
    volumes:
      - ./_volume_static:/spcgeonode-static/
      - ./_volume_media:/spcgeonode-media/
      - ./_volume_certbot-challenge:/spcgeonode-certbot-challenge/
      - ./_volume_certbot-keys:/spcgeonode-certbot-keys/
  django:
    image: olivierdalang/spcgeonode:django-dev
    environment:
      - "DEBUG=True"
    volumes:
      - './django:/spcgeonode/'
      - ./_volume_static:/spcgeonode-static/
      - ./_volume_media:/spcgeonode-media/
    command: ["uwsgi", "--chdir=/spcgeonode", "--module=spcgeonode.wsgi", "--env=DJANGO_SETTINGS_MODULE=spcgeonode.settings", "--socket=:8000", "--py-autoreload=2"]
  celery:
    image: olivierdalang/spcgeonode:django-dev
    volumes:
      - './django:/spcgeonode/'
  celerycam:
    image: olivierdalang/spcgeonode:django-dev
    volumes:
      - './django:/spcgeonode/'

  geoserver:
    image: olivierdalang/spcgeonode:geoserver-dev
    volumes:
      - ./_volume_geodatadir:/spcgeonode-geodatadir/

  letsencrypt:
    image: olivierdalang/spcgeonode:letsencrypt-dev
    volumes:
      - ./_volume_certbot-challenge:/spcgeonode-certbot-challenge/
      - ./_volume_certbot-keys:/spcgeonode-certbot-keys/

  # backuper:
  #   volumes:
  #     # - ./_volume_database:/tobackup/spcgeonode-database/ # doesn't work because of ownership
  #     - ./_volume_media:/tobackup/spcgeonode-media/
  #     - ./_volume_geodatadir:/tobackup/spcgeonode-geodatadir/

secrets:
  admin_username:
    file: _devsecrets/admin_username
    external: false
  admin_password:
    file: _devsecrets/admin_password
    external: false